From 600c1d0064040765c4c90d9570711f5f1d2adf2d Mon Sep 17 00:00:00 2001
From: Dennis <dyurkevich@radiumone.com>
Date: Wed, 2 Dec 2015 09:58:52 +0000
Subject: [PATCH 1/3] second commit

---
 app/routes/index.js | 19 +++++++++++++++----
 script/trac.js      | 13 +------------
 server.js           |  1 +
 3 files changed, 17 insertions(+), 16 deletions(-)

diff --git a/app/routes/index.js b/app/routes/index.js
index b08f7b0..2642089 100644
--- a/app/routes/index.js
+++ b/app/routes/index.js
@@ -2,6 +2,9 @@
 
 module.exports = function (app, db) {
     
+    var qs = require("querystring");
+    var _ = require("underscore");
+    
     app.route("/")
         .get(function(req, res){
             res.sendFile(process.cwd() + "/public/index.html");
@@ -9,16 +12,24 @@ module.exports = function (app, db) {
         
     app.route("/script")
         .get(function(req, res){
-            res.send("<script type='text/javascript' src='https://trac-server-ydennisy-1.c9users.io/script/trac.js'></script>");
+            res.send("<script type='text/javascript' src='https://trac-ydennisy.c9users.io/script/trac.js'></script>");
         });
     
     app.route("/api")
         .post(function(req, res){
-            console.log(req.url);
-            console.log(req.body);
-            db.collection("seconds").insert(req.body, function (err){
+            
+            var str = req.url.split("?")[1];
+            console.log(str);
+            var parsedQuery = qs.parse(str);
+            console.log("trying to parse...."+ parsedQuery.advid);
+            
+            var dataToInsert = {};
+            _.extend(dataToInsert, req.body, str);
+            
+            db.collection("seconds").insert(dataToInsert, function (err){
                 if (err) { throw err }
             });
+            console.log(dataToInsert);
             res.end();
         })
         
diff --git a/script/trac.js b/script/trac.js
index cff195c..6fd3bdb 100644
--- a/script/trac.js
+++ b/script/trac.js
@@ -2,7 +2,7 @@ document.write("script loaded");
 document.write(document.referrer);
 
 function postStaticData (ts, queryS, cookies, ua, focus, urlloc, scripts){
-    var url = "https://trac-server-ydennisy-1.c9users.io/api";
+    var url = "https://trac-ydennisy.c9users.io/api";
     var xhr = new XMLHttpRequest();
     xhr.open("POST", url, true);
     xhr.setRequestHeader("Content-type", "application/json;charset=UTF-8");
@@ -44,14 +44,3 @@ var scriptsOnPage = function(){
 };
 
 postStaticData(getBrowserTimestamp(), queryString(), checkCookies(), getUserAgent(), tabStateOnLoad(), url(), scriptsOnPage());
-
-
-
-
-// var secs = 0;
-// function incrementDwellTime(){
-//     postSecondsData(secs);
-//     secs++;
-// }
-
-// setInterval(incrementDwellTime, 1000);
\ No newline at end of file
diff --git a/server.js b/server.js
index c169f3d..04b9eae 100644
--- a/server.js
+++ b/server.js
@@ -3,6 +3,7 @@
 var express = require("express");
 var http = require('http');
 var url = require('url');
+var qs = require("querystring");
 var bodyParser = require("body-parser");
 var mongo = require("mongodb").MongoClient;
 var route = require("./app/routes/index.js");
-- 
1.9.1

